<?xml version="1.0" encoding="UTF-8"?>
<svg width="1000" height="800" xmlns="http://www.w3.org/2000/svg">
  <!-- Background -->
  <rect width="1000" height="800" fill="#f8f9fa"/>
  
  <!-- Title -->
  <text x="500" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#2c3e50">User Query Flow: Frontend to Backend</text>
  
  <!-- Frontend Section -->
  <rect x="50" y="60" width="200" height="150" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="10"/>
  <text x="150" y="80" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#1976d2">Frontend</text>
  <text x="60" y="100" font-family="Arial, sans-serif" font-size="11" fill="#333">1. User types query</text>
  <text x="60" y="115" font-family="Arial, sans-serif" font-size="11" fill="#333">2. sendMessage() triggered</text>
  <text x="60" y="130" font-family="Arial, sans-serif" font-size="11" fill="#333">3. POST /api/query</text>
  <text x="60" y="145" font-family="Arial, sans-serif" font-size="11" fill="#333">4. Display loading</text>
  <text x="60" y="160" font-family="Arial, sans-serif" font-size="10" fill="#666">script.js:45-96</text>
  <text x="60" y="175" font-family="Arial, sans-serif" font-size="10" fill="#666">index.html</text>

  <!-- API Gateway -->
  <rect x="300" y="60" width="200" height="150" fill="#fff3e0" stroke="#f57c00" stroke-width="2" rx="10"/>
  <text x="400" y="80" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#f57c00">API Gateway</text>
  <text x="310" y="100" font-family="Arial, sans-serif" font-size="11" fill="#333">1. FastAPI receives request</text>
  <text x="310" y="115" font-family="Arial, sans-serif" font-size="11" fill="#333">2. Validate QueryRequest</text>
  <text x="310" y="130" font-family="Arial, sans-serif" font-size="11" fill="#333">3. Create/get session</text>
  <text x="310" y="145" font-family="Arial, sans-serif" font-size="11" fill="#333">4. Forward to RAG system</text>
  <text x="310" y="175" font-family="Arial, sans-serif" font-size="10" fill="#666">app.py:56-74</text>

  <!-- RAG System -->
  <rect x="550" y="60" width="200" height="150" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="2" rx="10"/>
  <text x="650" y="80" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#7b1fa2">RAG System</text>
  <text x="560" y="100" font-family="Arial, sans-serif" font-size="11" fill="#333">1. Create AI prompt</text>
  <text x="560" y="115" font-family="Arial, sans-serif" font-size="11" fill="#333">2. Get conversation history</text>
  <text x="560" y="130" font-family="Arial, sans-serif" font-size="11" fill="#333">3. Call AI with tools</text>
  <text x="560" y="145" font-family="Arial, sans-serif" font-size="11" fill="#333">4. Extract sources</text>
  <text x="560" y="175" font-family="Arial, sans-serif" font-size="10" fill="#666">rag_system.py:102-140</text>

  <!-- AI Generator -->
  <rect x="120" y="270" width="200" height="150" fill="#e8f5e8" stroke="#388e3c" stroke-width="2" rx="10"/>
  <text x="220" y="290" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#388e3c">AI Generator</text>
  <text x="130" y="310" font-family="Arial, sans-serif" font-size="11" fill="#333">1. Process with Claude AI</text>
  <text x="130" y="325" font-family="Arial, sans-serif" font-size="11" fill="#333">2. Determine if search needed</text>
  <text x="130" y="340" font-family="Arial, sans-serif" font-size="11" fill="#333">3. Execute tools if required</text>
  <text x="130" y="355" font-family="Arial, sans-serif" font-size="11" fill="#333">4. Generate final response</text>
  <text x="130" y="385" font-family="Arial, sans-serif" font-size="10" fill="#666">ai_generator.py:43-87</text>

  <!-- Search Tool -->
  <rect x="370" y="270" width="200" height="150" fill="#fff8e1" stroke="#fbc02d" stroke-width="2" rx="10"/>
  <text x="470" y="290" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#fbc02d">Course Search Tool</text>
  <text x="380" y="310" font-family="Arial, sans-serif" font-size="11" fill="#333">1. Semantic vector search</text>
  <text x="380" y="325" font-family="Arial, sans-serif" font-size="11" fill="#333">2. Apply course/lesson filters</text>
  <text x="380" y="340" font-family="Arial, sans-serif" font-size="11" fill="#333">3. Format with context</text>
  <text x="380" y="355" font-family="Arial, sans-serif" font-size="11" fill="#333">4. Store source info</text>
  <text x="380" y="385" font-family="Arial, sans-serif" font-size="10" fill="#666">search_tools.py:52-86</text>

  <!-- Vector Store -->
  <rect x="620" y="270" width="200" height="150" fill="#fce4ec" stroke="#c2185b" stroke-width="2" rx="10"/>
  <text x="720" y="290" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#c2185b">Vector Store</text>
  <text x="630" y="310" font-family="Arial, sans-serif" font-size="11" fill="#333">1. ChromaDB embeddings</text>
  <text x="630" y="325" font-family="Arial, sans-serif" font-size="11" fill="#333">2. Course metadata</text>
  <text x="630" y="340" font-family="Arial, sans-serif" font-size="11" fill="#333">3. Content chunks</text>
  <text x="630" y="355" font-family="Arial, sans-serif" font-size="11" fill="#333">4. Similarity search</text>
  <text x="630" y="385" font-family="Arial, sans-serif" font-size="10" fill="#666">vector_store.py</text>

  <!-- Response Assembly -->
  <rect x="180" y="480" width="250" height="120" fill="#e1f5fe" stroke="#0277bd" stroke-width="2" rx="10"/>
  <text x="305" y="500" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#0277bd">Response Assembly</text>
  <text x="190" y="520" font-family="Arial, sans-serif" font-size="11" fill="#333">1. Package (answer, sources) tuple</text>
  <text x="190" y="535" font-family="Arial, sans-serif" font-size="11" fill="#333">2. Create QueryResponse model</text>
  <text x="190" y="550" font-family="Arial, sans-serif" font-size="11" fill="#333">3. Return JSON to frontend</text>
  <text x="190" y="580" font-family="Arial, sans-serif" font-size="10" fill="#666">app.py:68-72</text>

  <!-- Frontend Response -->
  <rect x="480" y="480" width="250" height="120" fill="#e8f5e8" stroke="#2e7d32" stroke-width="2" rx="10"/>
  <text x="605" y="500" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#2e7d32">Frontend Response</text>
  <text x="490" y="520" font-family="Arial, sans-serif" font-size="11" fill="#333">1. Parse JSON response</text>
  <text x="490" y="535" font-family="Arial, sans-serif" font-size="11" fill="#333">2. Remove loading message</text>
  <text x="490" y="550" font-family="Arial, sans-serif" font-size="11" fill="#333">3. Display answer + sources</text>
  <text x="490" y="565" font-family="Arial, sans-serif" font-size="11" fill="#333">4. Re-enable input</text>
  <text x="490" y="580" font-family="Arial, sans-serif" font-size="10" fill="#666">script.js:76-95</text>

  <!-- Flow Arrows -->
  <!-- Frontend to API -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
  </defs>
  
  <line x1="250" y1="135" x2="300" y2="135" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="275" y="130" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">HTTP POST</text>

  <!-- API to RAG -->
  <line x1="500" y1="135" x2="550" y2="135" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="525" y="130" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">query()</text>

  <!-- RAG to AI -->
  <line x1="600" y1="210" x2="270" y2="270" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="420" y="235" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">generate_response()</text>

  <!-- AI to Search -->
  <line x1="320" y1="345" x2="370" y2="345" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="345" y="340" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">tool call</text>

  <!-- Search to Vector -->
  <line x1="570" y1="345" x2="620" y2="345" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="595" y="340" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">search()</text>

  <!-- Vector back to Search -->
  <line x1="620" y1="360" x2="570" y2="360" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="595" y="375" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">results</text>

  <!-- Search back to AI -->
  <line x1="370" y1="375" x2="320" y2="375" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="345" y="390" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">formatted results</text>

  <!-- AI to Response Assembly -->
  <line x1="270" y1="420" x2="305" y2="480" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="280" y="455" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">response</text>

  <!-- Response Assembly to Frontend Response -->
  <line x1="430" y1="540" x2="480" y2="540" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="455" y="535" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">JSON</text>

  <!-- Session Manager (side component) -->
  <rect x="820" y="60" width="150" height="100" fill="#fff" stroke="#666" stroke-width="1" stroke-dasharray="5,5" rx="5"/>
  <text x="895" y="80" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#666">Session Manager</text>
  <text x="830" y="95" font-family="Arial, sans-serif" font-size="10" fill="#666">• Track conversations</text>
  <text x="830" y="110" font-family="Arial, sans-serif" font-size="10" fill="#666">• Maintain history</text>
  <text x="830" y="125" font-family="Arial, sans-serif" font-size="10" fill="#666">• Context persistence</text>

  <!-- Data Flow Legend -->
  <rect x="50" y="650" width="900" height="120" fill="#fff" stroke="#ccc" stroke-width="1" rx="5"/>
  <text x="70" y="670" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#333">Data Flow Summary:</text>
  
  <text x="70" y="690" font-family="Arial, sans-serif" font-size="11" fill="#333">1. User enters query → Frontend validates and sends HTTP POST to /api/query</text>
  <text x="70" y="705" font-family="Arial, sans-serif" font-size="11" fill="#333">2. FastAPI routes to RAG system → Creates/retrieves session and processes query</text>
  <text x="70" y="720" font-family="Arial, sans-serif" font-size="11" fill="#333">3. AI Generator decides if search needed → Calls Course Search Tool if required</text>
  <text x="70" y="735" font-family="Arial, sans-serif" font-size="11" fill="#333">4. Search Tool queries Vector Store → Returns formatted results with sources</text>
  <text x="70" y="750" font-family="Arial, sans-serif" font-size="11" fill="#333">5. AI generates final response → System packages as JSON and returns to frontend</text>
  <text x="70" y="765" font-family="Arial, sans-serif" font-size="11" fill="#333">6. Frontend displays response and sources → Re-enables input for next query</text>
</svg>